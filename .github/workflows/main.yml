name: Versioned Hajimi Release

on:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶å‡†ç‚¹è§¦å‘
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version
      id: version
      run: |
        VERSION=$(cat version.txt | cut -d'=' -f2 | tr -d '[:space:]')
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "::notice:: Using version: ${VERSION}"

    - name: Inject build uniqueness
      run: |
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        # å‘appæ³¨å…¥å”¯ä¸€æ€§æ ‡è¯†
        echo "build_time=${TIMESTAMP}" > app/build_info.env
        # æ„é€ æœ€ç»ˆæ–‡ä»¶å
        echo "HAJIMI_NAME=hajimi-v${{ steps.version.outputs.version }}-${TIMESTAMP}.zip" >> $GITHUB_ENV
        # æ„é€ Releaseæ ‡é¢˜
        echo "release_title=ğŸ•Šï¸ Hajimi v${{ steps.version.outputs.version }} (${TIMESTAMP})" >> $GITHUB_ENV

    - name: Create app.zip
      run: |
        cd app && zip -r ../app.zip ./*
        # ç”Ÿæˆå“ˆå¸Œæ ¡éªŒæ–‡ä»¶
        sha256sum app.zip | awk '{print $1}' > hash.sha256

    - name: Package final bundle
      run: |
        zip -r ${{ env.HAJIMI_NAME }} \
          app.zip \
          Dockerfile \
          requirements.txt \
          version.txt \
          hash.sha256

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ steps.version.outputs.version }}"
        name: "${{ env.release_title }}"
        body: | 
          ğŸš€ è‡ªåŠ¨æ„å»ºä¿¡æ¯ï¼š
          - æ„å»ºæ—¶é—´ï¼š${{ env.TIMESTAMP }}
          - åº”ç”¨å“ˆå¸Œï¼š$(cat hash.sha256)
          - ç‰ˆæœ¬æ–‡ä»¶ï¼š$(cat version.txt)
        files: |
          ${{ env.HAJIMI_NAME }}
        draft: false
        prerelease: false
        overwrite_assets: true
